<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="/w3css/4/w3.css">
<style>
body		{margin: 0 1 0 0; border-style: solid;border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; border-color:#29A2DB;}
textarea	{font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; color: black; font-weight: normal; background-color: #ffffff; border-style: solid; border-color:#29A2DB; border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; }
h1   {color:#fff; background-color:#0099db; padding: 50px;}
p    {color:black;}

#oilflows, .flowbutton, text{
    font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
    border-collapse: collapse;
		font-size: 12px;
    width: 100%;
}

#oilflows td, #oilflows th {
    border: 1px solid #ddd;
    padding: 8px;
}

#oilflows tr:nth-child(even){background-color: #f2f2f2;}

#oilflows tr:hover {background-color: #ddd;}

#oilflows th {
    padding-top: 12px;
    padding-bottom: 12px;
    text-align: left;
    background-color: #0099db;
    color: white;
}

.flowbutton {
    padding-top: 2px;
    padding-bottom: 2px;
    text-align: center;
    background-color: #0099db;
    color: white;
}
#save{
	width:20;
	align-content: left;
}
#cancel{
	width:20;
	align-content: center;
}

#flowEdit {
	background-color: #ddd;
	color:white;
	display:none;	
}

#editFormHeader {
	background-color: #0099db;
}
label {
	color:#0099db;	
}
</style>

<script>

var OilFlows;	
var theNameOfTheFile;
var editFlowid;

var buildOptions=true;

function getData()
{
	try
	{
		return;
	}
	catch(e)
	{
		alert("getData - foutje "+e);
	}
}

function writeElement(element,writeOption)
{
	try
	{
		var txt = "";
		if(element.hasOwnProperty("flow"))
		{
			txt+="<td>"+element.flow+"</td>";
			if(buildOptions==true)
			{
				document.getElementById("options").innerHTML+="<option>"+element.flow+"</option>";
			}
		}
		else
		{
			txt+="<td></td>";
		}
		if(element.hasOwnProperty("info")) 
		{
			if(element.info.hasOwnProperty("Consumer"))
			{
				txt+="<td>"+element.info.Consumer+"</td>";
			}
			else
			{
				txt+="<td></td>";
			}
			if(element.info.hasOwnProperty("Interfaces"))
			{
				txt+="<td>"+element.info.Interfaces+"</td>";
			}
			else
			{
				txt+="<td></td>";
			}
			if(element.info.hasOwnProperty("Component"))
			{
				txt+="<td>"+element.info.Component+"</td>";
			}
			else
			{
				txt+="<td></td>";
			}
			if(element.info.hasOwnProperty("ResponseFlow"))
			{
				txt+="<td>"+element.info.ResponseFlow+"</td>";
			}
			else
			{
				txt+="<td></td>";
			}
			if(element.info.hasOwnProperty("Documents"))
			{
				txt+="<td>"+element.info.Documents+"</td>";
			}
			else
			{
				txt+="<td></td>";
			}
			txt+="<td><button class=\"flowbutton\" id=\""+element.flow+"\" name=\""+element.flow+"\" onclick=\"myFunction(id)\">Edit</button></td>";
		}
		else
		{
			txt+="<td></td><td></td><td></td>";
		}
		txt+="</tr>";
		return txt;
	}
	catch(e)
	{
		return(e);
	}
};

function writeOilFlow(flowName)
{
		var txt = "";		
		txt=txt+"<table id=\"oilflows\"><tr><th>Flow</th><th>Consumer</th><th>Interfaces</th><th>Component</th><th>Response flow</th><th>Document References</th><th>Action</th></tr>";
		for(var i=0; i<OilFlows.flows.length; i++)
		{
			if(flowName=="")
			{ 
				txt+=writeElement(OilFlows.flows[i]);
			}
			else if(OilFlows.flows[i].flow==flowName)
			{
				txt+=writeElement(OilFlows.flows[i]);
			}
		}
		txt=txt+"</table>";
		document.getElementById("list").innerHTML = txt;
		buildOptions=false;
};

function NieuweKeuze()
{
	var selectedFlow = document.test.tata[document.test.tata.selectedIndex].value;
	var selectedIndex = document.test.tata.selectedIndex;
	writeOilFlow(selectedFlow);
	document.test.tata.selectedIndex = selectedIndex;
	document.editForm.style.display="none";
	return true;
};


function myFunction(id) 
{
 for(var j=0; j<OilFlows.flows.length; j++)
 {
	 if(OilFlows.flows[j].flow==id)
	 { 
    editFlowid=j;
		writeOilFlow(OilFlows.flows[j].flow);
		document.test.tata.selectedIndex = j+1;
		try
		{
			document.getElementById("editFormHeader").innerHTML="Edit Oil Flow: "+OilFlows.flows[j].flow;
			document.editForm.style.display="block";
			if(OilFlows.flows[j].info.hasOwnProperty("Consumer"))
			{
				document.editForm.Consumer.value=OilFlows.flows[j].info.Consumer;
			}
			else
			{
				document.editForm.Consumer.value="";
			}
			if(OilFlows.flows[j].info.hasOwnProperty("Interfaces"))
			{
				document.editForm.Interfaces.value=OilFlows.flows[j].info.Interfaces;
			}
			else
			{
				document.editForm.Interfaces.value="";
			}
			if(OilFlows.flows[j].info.hasOwnProperty("Component"))
			{
				document.editForm.Component.value=OilFlows.flows[j].info.Component;
			}
			else
			{
				document.editForm.Component.value="";
			}
			if(OilFlows.flows[j].info.hasOwnProperty("ResponseFlow"))
			{
				document.editForm.ResponseFlow.value=OilFlows.flows[j].info.ResponseFlow;
			}
			else
			{
				document.editForm.ResponseFlow.value="";
			}
			if(OilFlows.flows[j].info.hasOwnProperty("Documents"))
			{
				document.editForm.Documents.value=OilFlows.flows[j].info.Documents;
			}
			else
			{
				document.editForm.Documents.value="";
			}
			var saveBttn = document.getElementById("save");
			saveBttn.disabled=true;
			saveBttn.style.backgroundColor="grey";
			document.getElementById("cancel").scrollIntoView();
		}
		catch(e)
		{
			alert("foutje in myFunction => "+e);
		}
		break;
	 }
 }
};

function saveEdit()
{
	document.editForm.style.display="none";
	OilFlows.flows[editFlowid].info.Consumer=document.editForm.Consumer.value;
	OilFlows.flows[editFlowid].info.Interfaces=document.editForm.Interfaces.value;
	OilFlows.flows[editFlowid].info.Component=document.editForm.Component.value;
	OilFlows.flows[editFlowid].info.ResponseFlow=document.editForm.ResponseFlow.value;
	OilFlows.flows[editFlowid].info.Documents=document.editForm.Documents.value;
 	writeOilFlow(OilFlows.flows[editFlowid].flow);
	document.test.tata.selectedIndex = editFlowid+1;
	document.getElementById("saveFile").style.display="block";
	return true;
}

function cancelEdit()
{
	document.editForm.style.display="none";
 	writeOilFlow(OilFlows.flows[editFlowid].flow);
	document.test.tata.selectedIndex = editFlowid+1;
	return true;
}


function saveFile()
{
	try
	{	// The download function takes a CSV string, the filename and mimeType as parameters
		// Scroll/look down at the bottom of this snippet to see how download is called
		var download = function(content, fileName, mimeType) 
				{
  					var a = document.createElement('a');
  					mimeType = mimeType || 'application/octet-stream';

  					if (navigator.msSaveBlob) 
						{	// IE10
    						navigator.msSaveBlob(new Blob([content], {type: mimeType}), fileName);
						}
						else 
							if (URL && 'download' in a)
							{ //html5 A[download]
								a.href = URL.createObjectURL(new Blob([content], {type: mimeType}));
								a.setAttribute('download', fileName);
								document.body.appendChild(a);
								a.click();
								document.body.removeChild(a);
							}
							else
							{
    						location.href = 'data:application/octet-stream,' + encodeURIComponent(content); // only this mime type is supported
  						}
				};
		var jsonContent=JSON.stringify(OilFlows,null,'  ');
		download(jsonContent, theNameOfTheFile, 'text/json;encoding:utf-8');	
	}
	catch(e)
	{
		alert("foutje in saveFile: "+e);
	}
	return;
}

function enableButton()
{
	try
	{
		var el=document.getElementById("save");
		if(el.disabled==true)
		{
			el.disabled=false;
			el.style.backgroundColor="#0099db";
		}
	}
	catch(e)
	{
		alert("foutje in enableButton "+e);
	}
}

</script>

</head>
<body onload="getData()">
<!--	<script>
	navigator.webkitPersistentStorage.requestQuota(1024*1024, function() {
		&nbsp;window.webkitRequestFileSystem(window.PERSISTENT , 1024*1024, SaveDatFileBro);
	 })
	</script> -->
	 <h1 align="center">Oil Flows Summary</h1>
<table>
	<tr>
		<td><text>Select flows definition file: </text><input type="file" id="defFile" accept=".json" size="80"></td>
		<td><text><button id="saveFile" name="saveFile" type="button" style="display:none;" onclick="saveFile()">Save file update</button></td>
	</tr>
</table>

<!--<output id="fileInfo"></output>-->
<output id="trace"></output>
<br> 
<form name="test">
Select tracking domain: <select name="tata" id="options" onChange="NieuweKeuze()">
</select>
</form>
<br>
<output id="list" ></output>
<br>

<form name="editForm" id="flowEdit">
	<h2 id="editFormHeader">Edit Oil Flow: tata</h2>
	<label>Consumer(s): </label><br><input type="text" name="Consumer" style="width:100%; border:0px; padding-top: 8px;	padding-bottom: 8px; border-collapse: collapse;" onchange="enableButton()"placeholder="List here the consumers that initiate the flow ...">
	<br>
	<label>Interfaces: </label><br><input type="text" name="Interfaces" style="width:100%; border:0px; padding-top: 8px;	padding-bottom: 8px;" onchange="enableButton()" placeholder="Define here the OIL interfaces used by the consumers in this flow ...">
	<br>
	<label>Component: </label><br><input type="text" name="Component" style="width:100%; border:0px; padding-top: 8px;	padding-bottom: 8px;" onchange="enableButton()" placeholder="List here the OIL components that implement the interface ...">
	<br>
	<label>ResponseFlow: </label><br><textarea rows="4" name="ResponseFlow" style="width:100%; border:0px; padding-top: 8px; padding-bottom: 8px;" onchange="enableButton()"  placeholder="Describe response flow here ..."></textarea>
	<br>
	<label>Documents: </label><br><input type="text" name="Documents" style="width:100%; border:0px; padding-top: 8px;	padding-bottom: 8px;" onchange="enableButton()" placeholder="List documents on this flow ...">
	<br>
	<br>
	<table style="width:100%">
		<tr>
			<td style="width:40%"></td>
			<td style="width:10%;padding-right:12px;"><button id="save" type="button" class="flowbutton" onclick="saveEdit()">Save</button></td>
			<td style="width:10%;padding-left:12px;"><button id="cancel" type="button" class="flowbutton" onclick="cancelEdit()">Cancel</button></td>
			<td style="width:40%"></td>
		</tr>
	</table>
	<br> 
</form>

<script>
	function readOilFlows(evt) 
	{
		var file = evt.target.files[0]; // FileList object
		theNameOfTheFile = file.name;
			try
		{
			var reader = new FileReader();
			if(reader)
			{
				try
				{
					reader.onload = function()
					{
						var data = reader.result;
						OilFlows = JSON.parse(data);
						if(!OilFlows.hasOwnProperty("flows")) 
						{
						    	alert("Property 'flows' not found in definition file! Select another file.");
						    	return false;
						}
						for( var i=0; i<OilFlows.flows.length; i++)
						{
						    	var elem = OilFlows.flows[i];
						    	if(elem.hasOwnProperty("flow") && elem.hasOwnProperty("info")) continue;
						    	alert("Property 'flow' or 'info' element ["+i+"]");
						    	return false;
						}
						document.test.tata.innerHTML="<option></option>";	
						buildOptions=true;	
						document.editForm.style.display="none";
						writeOilFlow("");
					};
					reader.onerror = function()
					{
						document.getElementById("trace").innerHTML+="onerror function called.<br>";
					};
					reader.readAsText(file);
				}
				catch(e)
				{
					alert("catched error "+e);
				}
			}
			else
			{
				document.getElementById("trace").innerHTML+="FileReader NOT supported!<br>";
			};
		}
		catch(e)
		{
				alert("catched error "+e);
		}
  }
	document.getElementById('defFile').addEventListener('change', readOilFlows, false);	
</script>


</body>
</html>